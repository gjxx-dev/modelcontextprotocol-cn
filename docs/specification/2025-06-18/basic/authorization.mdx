---
title: 授权
---

<div id="enable-section-numbers" />

<Info>**协议修订版**：2025-06-18</Info>

## 介绍

### 目的和范围

模型上下文协议在传输级别提供授权功能，使 MCP 客户端能够代表资源所有者向受限的 MCP 服务器发出请求。本规范定义了基于 HTTP 的传输的授权流程。

### 协议要求

授权对于 MCP 实现是**可选的**。当支持时：

- 使用基于 HTTP 的传输的实现**应该**符合此规范。
- 使用 STDIO 传输的实现**不应该**遵循此规范，而是从环境中检索凭据。
- 使用替代传输的实现**必须**遵循其协议的既定安全最佳实践。

### 标准合规性

此授权机制基于下面列出的既定规范，但实现了其功能的选定子集，以确保安全性和互操作性，同时保持简单性：

- OAuth 2.1 IETF DRAFT ([draft-ietf-oauth-v2-1-13](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13))
- OAuth 2.0 授权服务器元数据 ([RFC8414](https://datatracker.ietf.org/doc/html/rfc8414))
- OAuth 2.0 动态客户端注册协议 ([RFC7591](https://datatracker.ietf.org/doc/html/rfc7591))
- OAuth 2.0 受保护资源元数据 ([RFC9728](https://datatracker.ietf.org/doc/html/rfc9728))

## 授权流程

### 角色

受保护的 _MCP 服务器_ 充当 [OAuth 2.1 资源服务器](https://www.ietf.org/archive/id/draft-ietf-oauth-v2-1-13.html#name-roles)，能够接受并响应使用访问令牌的受保护资源请求。

_MCP 客户端_ 充当 [OAuth 2.1 客户端](https://www.ietf.org/archive/id/draft-ietf-oauth-v2-1-13.html#name-roles)，代表资源所有者发出受保护资源请求。

_授权服务器_ 负责与用户交互（如果必要）并为 MCP 服务器使用发出访问令牌。授权服务器的实现细节超出了本规范的范围。它可以与资源服务器托管在一起或作为单独实体。[授权服务器发现部分](#authorization-server-discovery) 指定了 MCP 服务器如何向客户端指示其相应授权服务器的位置。

### 概述

1. 授权服务器**必须**实现 OAuth 2.1，并为机密和公共客户端实施适当的安全措施。

1. 授权服务器和 MCP 客户端**应该**支持 OAuth 2.0 动态客户端注册协议 ([RFC7591](https://datatracker.ietf.org/doc/html/rfc7591))。

1. MCP 服务器**必须**实现 OAuth 2.0 受保护资源元数据 ([RFC9728](https://datatracker.ietf.org/doc/html/rfc9728))。MCP 客户端**必须**使用 OAuth 2.0 受保护资源元数据进行授权服务器发现。

1. 授权服务器**必须**提供 OAuth 2.0 授权服务器元数据 ([RFC8414](https://datatracker.ietf.org/doc/html/rfc8414))。MCP 客户端**必须**使用 OAuth 2.0 授权服务器元数据。

### 授权服务器发现

本部分描述了 MCP 服务器如何向 MCP 客户端公布其关联的授权服务器的机制，以及 MCP 客户端如何通过发现过程确定授权服务器端点和支持功能的机制。

#### 授权服务器位置

MCP 服务器**必须**实现 OAuth 2.0 受保护资源元数据 ([RFC9728](https://datatracker.ietf.org/doc/html/rfc9728)) 规范，以指示授权服务器的位置。MCP 服务器返回的受保护资源元数据文档**必须**包含 `authorization_servers` 字段，其中至少包含一个授权服务器。

`authorization_servers` 的具体使用超出了本规范的范围；实现者应查阅 OAuth 2.0 受保护资源元数据 ([RFC9728](https://datatracker.ietf.org/doc/html/rfc9728)) 以获取实现细节的指导。

实现者应注意，受保护资源元数据文档可以定义多个授权服务器。选择使用哪个授权服务器的责任在于 MCP 客户端，按照 [RFC9728 第7.6节"授权服务器"](https://datatracker.ietf.org/doc/html/rfc9728#name-authorization-servers) 中指定的指南。

MCP 服务器**必须**在返回 _401 未授权_ 时使用 HTTP 头 `WWW-Authenticate` 来指示资源服务器元数据 URL 的位置，如 [RFC9728 第5.1节"WWW-Authenticate 响应"](https://datatracker.ietf.org/doc/html/rfc9728#name-www-authenticate-response) 中所述。

MCP 客户端**必须**能够解析 `WWW-Authenticate` 头并适当地响应来自 MCP 服务器的 `HTTP 401 未授权` 响应。

#### 服务器元数据发现

MCP 客户端**必须**遵循 OAuth 2.0 授权服务器元数据 [RFC8414](https://datatracker.ietf.org/doc/html/rfc8414) 规范，以获取与授权服务器交互所需的信息。

#### 序列图

The following diagram outlines an example flow:

```mermaid
sequenceDiagram
    participant C as Client
    participant M as MCP Server (Resource Server)
    participant A as Authorization Server

    C->>M: MCP request without token
    M-->>C: HTTP 401 Unauthorized with WWW-Authenticate header
    Note over C: Extract resource_metadata<br />from WWW-Authenticate

    C->>M: GET /.well-known/oauth-protected-resource
    M-->>C: Resource metadata with authorization server URL
    Note over C: Validate RS metadata,<br />build AS metadata URL

    C->>A: GET /.well-known/oauth-authorization-server
    A-->>C: Authorization server metadata

    Note over C,A: OAuth 2.1 authorization flow happens here

    C->>A: Token request
    A-->>C: Access token

    C->>M: MCP request with access token
    M-->>C: MCP response
    Note over C,M: MCP communication continues with valid token
```

### 动态客户端注册

MCP 客户端和授权服务器**应该**支持 OAuth 2.0 动态客户端注册协议 [RFC7591](https://datatracker.ietf.org/doc/html/rfc7591)，以允许 MCP 客户端在无需用户交互的情况下获取 OAuth 客户端 ID。这为客户端提供了与新授权服务器自动注册的标准化方式，这对 MCP 至关重要，因为：

- 客户端可能事先不知道所有可能的 MCP 服务器及其授权服务器。
- 手动注册会给用户造成摩擦。
- 它实现了与新 MCP 服务器及其授权服务器的无缝连接。
- 授权服务器可以实施自己的注册策略。

任何_不支持_动态客户端注册的授权服务器都需要提供获取客户端 ID（以及如果适用，客户端凭据）的替代方式。对于这些授权服务器之一，MCP 客户端将不得不：

1. 为 MCP 客户端专门硬编码一个客户端 ID（以及如果适用，客户端凭据），用于与该授权服务器交互时使用，或
2. 向用户呈现一个 UI，允许他们在自己注册 OAuth 客户端后输入这些详细信息（例如，通过服务器托管的配置界面）。

### 授权流程步骤

完整的授权流程如下进行：

```mermaid
sequenceDiagram
    participant B as User-Agent (Browser)
    participant C as Client
    participant M as MCP Server (Resource Server)
    participant A as Authorization Server

    C->>M: MCP request without token
    M->>C: HTTP 401 Unauthorized with WWW-Authenticate header
    Note over C: Extract resource_metadata URL from WWW-Authenticate

    C->>M: Request Protected Resource Metadata
    M->>C: Return metadata

    Note over C: Parse metadata and extract authorization server(s)<br/>Client determines AS to use

    C->>A: GET /.well-known/oauth-authorization-server
    A->>C: Authorization server metadata response

    alt Dynamic client registration
        C->>A: POST /register
        A->>C: Client Credentials
    end

    Note over C: Generate PKCE parameters<br/>Include resource parameter
    C->>B: Open browser with authorization URL + code_challenge + resource
    B->>A: Authorization request with resource parameter
    Note over A: User authorizes
    A->>B: Redirect to callback with authorization code
    B->>C: Authorization code callback
    C->>A: Token request + code_verifier + resource
    A->>C: Access token (+ refresh token)
    C->>M: MCP request with access token
    M-->>C: MCP response
    Note over C,M: MCP communication continues with valid token
```

#### 资源参数实现

MCP 客户端**必须**按照 [RFC 8707](https://www.rfc-editor.org/rfc/rfc8707.html) 中定义的 OAuth 2.0 资源指示器来实现，以明确指定正在为其请求令牌的目标资源。`resource` 参数：

1. **必须**包含在授权请求和令牌请求中。
2. **必须**标识客户端打算使用令牌的 MCP 服务器。
3. **必须**使用 [RFC 8707 第2节](https://www.rfc-editor.org/rfc/rfc8707.html#name-access-token-request) 中定义的 MCP 服务器的规范 URI。

##### 规范服务器 URI

出于本规范的目的，MCP 服务器的规范 URI 定义为 [RFC 8707 第2节](https://www.rfc-editor.org/rfc/rfc8707.html#section-2) 中指定的资源标识符，并与 [RFC 9728](https://datatracker.ietf.org/doc/html/rfc9728) 中的 `resource` 参数保持一致。

MCP 客户端**应该**为他们打算访问的 MCP 服务器提供尽可能具体的 URI，按照 [RFC 8707](https://www.rfc-editor.org/rfc/rfc8707) 中的指导。虽然规范形式使用小写的方案和主机组件，但实现**应该**为了健壮性和互操作性而接受大写的方案和主机组件。

有效规范 URI 的示例：

- `https://mcp.example.com/mcp`
- `https://mcp.example.com`
- `https://mcp.example.com:8443`
- `https://mcp.example.com/server/mcp`（当路径组件对于标识单个 MCP 服务器是必要时）

无效规范 URI 的示例：

- `mcp.example.com`（缺少方案）
- `https://mcp.example.com#fragment`（包含片段）

> **注意：** 虽然 `https://mcp.example.com/`（带尾随斜杠）和 `https://mcp.example.com`（不带尾随斜杠）根据 [RFC 3986](https://www.rfc-editor.org/rfc/rfc3986) 都是技术上有效的绝对 URI，但实现**应该**为了更好的互操作性而一致使用不带尾随斜杠的形式，除非尾随斜杠对特定资源具有语义意义。

例如，如果访问位于 `https://mcp.example.com` 的 MCP 服务器，授权请求将包括：

```
&resource=https%3A%2F%2Fmcp.example.com
```

MCP clients **MUST** send this parameter regardless of whether authorization servers support it.

### Access Token Usage

#### Token Requirements

Access token handling when making requests to MCP servers **MUST** conform to the requirements defined in
[OAuth 2.1 Section 5 "Resource Requests"](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#section-5).
Specifically:

1. MCP 客户端**必须**使用 [OAuth 2.1 第5.1.1节](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#section-5.1.1) 中定义的授权请求头字段：

```
Authorization: Bearer <access-token>
```

请注意，授权**必须**包含在从客户端到服务器的每个 HTTP 请求中，即使它们是同一逻辑会话的一部分。

2. 访问令牌**不得**包含在 URI 查询字符串中

示例请求：

```http
GET /mcp HTTP/1.1
Host: mcp.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

#### 令牌处理

MCP 服务器，作为 OAuth 2.1 资源服务器的角色，**必须**按照 [OAuth 2.1 第5.2节](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#section-5.2) 中描述的方式验证访问令牌。MCP 服务器**必须**验证访问令牌是专门为它们作为预期受众而颁发的，按照 [RFC 8707 第2节](https://www.rfc-editor.org/rfc/rfc8707.html#section-2)。如果验证失败，服务器**必须**按照 [OAuth 2.1 第5.3节](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#section-5.3) 错误处理要求进行响应。无效或过期的令牌**必须**收到 HTTP 401 响应。

MCP 客户端**不得**向 MCP 服务器发送除 MCP 服务器的授权服务器颁发的令牌以外的任何令牌。

授权服务器**必须**只接受对其自己资源有效的令牌。

MCP 服务器**不得**接受或传递任何其他令牌。

### 错误处理

服务器**必须**为授权错误返回适当的 HTTP 状态码：

| 状态码 | 描述     | 使用               |
| ------ | -------- | ------------------ |
| 401    | 未授权   | 需要授权或令牌无效 |
| 403    | 禁止     | 无效范围或权限不足 |
| 400    | 错误请求 | 格式错误的授权请求 |

## 安全考虑

实现**必须**遵循 [OAuth 2.1 第7节"安全考虑"](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#name-security-considerations) 中列出的 OAuth 2.1 安全最佳实践。

### 令牌受众绑定和验证

[RFC 8707](https://www.rfc-editor.org/rfc/rfc8707.html) 资源指示器通过在授权服务器支持该功能时将令牌绑定到其预期受众来提供关键安全优势。为了启用当前和未来的采用：

- MCP 客户端**必须**按照 [资源参数实现](#resource-parameter-implementation) 部分的规定在授权和令牌请求中包含 `resource` 参数
- MCP 服务器**必须**验证呈现给它们的令牌是专门为它们使用而颁发的

[安全最佳实践文档](/specification/2025-06-18/basic/security_best_practices#token-passthrough) 概述了为什么令牌受众验证至关重要以及为什么明确禁止令牌传递。

### 令牌盗窃

获得客户端存储的令牌、或服务器上缓存或记录的令牌的攻击者可以使用看起来对资源服务器合法的请求访问受保护资源。

客户端和服务器**必须**实施安全的令牌存储并遵循 OAuth 最佳实践，如 [OAuth 2.1 第7.1节](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#section-7.1) 中所述。

授权服务器**应该**颁发短期访问令牌以减少泄露令牌的影响。对于公共客户端，授权服务器**必须**按照 [OAuth 2.1 第4.3.1节"令牌端点扩展"](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#section-4.3.1) 中描述的方式轮换刷新令牌。

### 通信安全

实现**必须**遵循 [OAuth 2.1 第1.5节"通信安全"](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#section-1.5)。

具体来说：

1. 所有授权服务器端点**必须**通过 HTTPS 提供服务。
1. 所有重定向 URI**必须**是 `localhost` 或使用 HTTPS。

### 授权码保护

获得授权响应中包含的授权码访问权限的攻击者可以尝试将授权码兑换为访问令牌或以其他方式使用授权码。（在 [OAuth 2.1 第7.5节](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#section-7.5) 中进一步描述）

为了缓解这一点，MCP 客户端**必须**按照 [OAuth 2.1 第7.5.2节](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#section-7.5.2) 实施 PKCE。PKCE 通过要求客户端创建秘密验证器-挑战对，帮助防止授权码拦截和注入攻击，确保只有原始请求者可以交换授权码以获取令牌。

### 开放重定向

攻击者可能制作恶意重定向 URI 来将用户引导到钓鱼站点。

MCP 客户端**必须**在授权服务器上注册重定向 URI。

授权服务器**必须**根据预注册值验证确切的重定向 URI 以防止重定向攻击。

MCP 客户端**应该**在授权码流程中使用并验证状态参数，并丢弃任何不包含或与原始状态不匹配的结果。

授权服务器**必须**采取预防措施以防止将用户代理重定向到不受信任的 URI，按照 [OAuth 2.1 第7.12.2节](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13#section-7.12.2) 中列出的建议。

授权服务器**应该**仅在信任重定向 URI 时自动重定向用户代理。如果 URI 不受信任，授权服务器可以通知用户并依赖用户做出正确决定。

### 混淆代理问题

攻击者可以利用作为第三方 API 中间人的 MCP 服务器，导致 [混淆代理漏洞](/specification/2025-06-18/basic/security_best_practices#confused-deputy-problem)。通过使用被盗的授权码，他们可以在未经用户同意的情况下获得访问令牌。

使用静态客户端 ID 的 MCP 代理服务器**必须**在转发到第三方授权服务器之前为每个动态注册的客户端获得用户同意（这可能需要额外同意）。

### 访问令牌权限限制

如果服务器接受为其他资源颁发的令牌，攻击者可以未经授权访问或以其他方式危害 MCP 服务器。

此漏洞有两个关键维度：

1. **受众验证失败。** 当 MCP 服务器不验证令牌是专门为其意图而颁发时（例如，通过受众声明，如 [RFC9068](https://www.rfc-editor.org/rfc/rfc9068.html) 中所述），它可能接受最初为其他服务颁发的令牌。这打破了基本的 OAuth 安全边界，允许攻击者在不同服务中重用合法令牌。
2. **令牌传递。** 如果 MCP 服务器不仅接受具有错误受众的令牌，而且还将这些未修改的令牌转发到下游服务，它可能导致 ["混淆代理"问题](#confused-deputy-problem)，其中下游 API 可能错误地信任令牌好像它来自 MCP 服务器或假设令牌已被上游 API 验证。请参阅安全最佳实践指南的 [令牌传递部分](/specification/2025-06-18/basic/security_best_practices#token-passthrough) 以获取更多详细信息。

MCP 服务器**必须**在处理请求之前验证访问令牌，确保访问令牌是专门为 MCP 服务器颁发的，并采取所有必要步骤确保不会向未经授权方返回数据。

MCP 服务器**必须**遵循 [OAuth 2.1 - 第5.2节](https://www.ietf.org/archive/id/draft-ietf-oauth-v2-1-13.html#section-5.2) 中的指南来验证入站令牌。

MCP 服务器**必须**只接受专门为其意图的令牌，并且**必须**拒绝不包括它们在受众声明中的令牌或以其他方式验证它们是令牌的预期接收者。请参阅 [安全最佳实践令牌传递部分](/specification/2025-06-18/basic/security_best_practices#token-passthrough) 以获取详细信息。

如果 MCP 服务器向上游 API 发出请求，它可能充当它们的 OAuth 客户端。在上游 API 使用的访问令牌是由上游授权服务器颁发的单独令牌。MCP 服务器**不得**传递它从 MCP 客户端接收的令牌。

MCP 客户端**必须**实施并使用 [RFC 8707 - OAuth 2.0 的资源指示器](https://www.rfc-editor.org/rfc/rfc8707.html) 中定义的 `resource` 参数，以明确指定正在为其请求令牌的目标资源。此要求与 [RFC 9728 第7.4节](https://datatracker.ietf.org/doc/html/rfc9728#section-7.4) 中的建议一致。这确保访问令牌绑定到其预期资源，并且不能跨不同服务被滥用。
